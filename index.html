<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p-blue: #2481cc; --bg: #f0f7ff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 80px; color: #333; }
        
        /* Header */
        .admin-header { background: linear-gradient(90deg, #1d71b8, #4a90e2); border-radius: 20px; padding: 15px; display: flex; justify-content: space-between; align-items: center; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .avatar { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; background: #eee; }

        /* Stats & Quick Links */
        .admin-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: white; padding: 10px; border-radius: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .quick-links { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .link-btn { padding: 12px; border-radius: 12px; border: none; font-weight: bold; color: white; cursor: pointer; text-align: center; text-decoration: none; font-size: 14px; }

        /* Coin Cards */
        .coin-card { background: white; border-radius: 25px; padding: 20px; margin-top: 15px; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #e0e0e0; }
        .offline-tag { position: absolute; top: 0; right: 0; background: #27ae60; color: white; padding: 5px 15px; font-size: 10px; border-bottom-left-radius: 15px; font-weight: bold; }
        .rate-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .rate-box { background: #f8fbff; padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #eef5ff; }
        .sell-btn { background: var(--p-blue); color: white; width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: bold; margin-top: 10px; cursor: pointer; transition: 0.3s; }
        .sell-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Pages */
        .page { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .order-item { background: white; padding: 15px; border-radius: 18px; margin-bottom: 15px; border-left: 6px solid #ff9800; box-shadow: 0 3px 10px rgba(0,0,0,0.05); }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 1px solid #ddd; box-sizing: border-box; }
        .admin-btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-accept { background: #27ae60; color: white; flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; }
        .btn-reject { background: #e74c3c; color: white; flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; }
        
        /* Control Switch */
        .control-box { background: #fff; padding: 10px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #ddd; }
        .switch-btn { padding: 5px 15px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="home-page">
        <div class="admin-header">
            <div style="display: flex; align-items: center;">
                <img id="user-pic" src="" class="avatar">
                <div style="margin-left: 10px;">
                    <b id="user-display-name">Loading...</b><br>
                    <small id="user-display-id">ID: 0000</small>
                </div>
            </div>
            <div style="text-align: right;"><small>Status</small><br><b>üü¢ Active</b></div>
        </div>

        <div class="quick-links">
            <a href="https://t.me/your_channel" class="link-btn" style="background: #0088cc;"><i class="fab fa-telegram"></i> Join Channel</a>
            <button class="link-btn" style="background: #ff9800;" onclick="alert('VPN section coming soon!')"><i class="fas fa-shield-alt"></i> Buy VPN</button>
        </div>

        <button id="admin-panel-btn" class="sell-btn" style="background: #333; display: none;" onclick="showPage('admin-page')">üëë Admin Dashboard</button>

        <div id="coin-market">
            <div class="coin-card">
                <div class="offline-tag" id="tag-Niva">ONLINE</div>
                <b>üü¢ Niva Coin</b>
                <div class="rate-grid">
                    <div class="rate-box"><small>Rate</small><br><b>3.5‡ß≥</b></div>
                    <div class="rate-box"><small>Limit</small><br><b>Unlimited</b></div>
                </div>
                <button class="sell-btn" id="btn-Niva" onclick="openForm('Niva', 3.5, 'shamim44035')">Sell Niva</button>
            </div>

            <div class="coin-card">
                <div class="offline-tag" id="tag-NS" style="background: #2481cc;">ONLINE</div>
                <b>üîµ NS Coin</b>
                <div class="rate-grid">
                    <div class="rate-box"><small>Rate</small><br><b>18‡ß≥</b></div>
                    <div class="rate-box"><small>Limit</small><br><b>Unlimited</b></div>
                </div>
                <button class="sell-btn" id="btn-NS" onclick="openForm('NS', 18, 'shamim44035')" style="background: #2481cc;">Sell NS</button>
            </div>

            <div class="coin-card">
                <div class="offline-tag" id="tag-Riva" style="background: #8e44ad;">ONLINE</div>
                <b>üü£ Riva Coin</b>
                <div class="rate-grid">
                    <div class="rate-box"><small>Rate</small><br><b>5.5‡ß≥</b></div>
                    <div class="rate-box"><small>Limit</small><br><b>Unlimited</b></div>
                </div>
                <button class="sell-btn" id="btn-Riva" onclick="openForm('Riva', 5.5, 'rivaminer5')" style="background: #8e44ad;">Sell Riva</button>
            </div>
        </div>
        
        <button class="sell-btn" style="background:#444; margin-top: 20px;" onclick="showPage('history-page')">üìú Transaction History</button>
    </div>

    <div id="admin-page" class="page">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>üëë Admin Panel</h3>
            <button onclick="showPage('home-page')" style="background: #eee; border: none; padding: 5px 15px; border-radius: 10px;">Back</button>
        </div>
        
        <div class="admin-stats">
            <div class="stat-box"><small>Pending</small><br><b id="count-pending">0</b></div>
            <div class="stat-box"><small>Paid</small><br><b id="count-paid">0</b></div>
            <div class="stat-box"><small>Rejected</small><br><b id="count-rej">0</b></div>
        </div>

        <h4 style="margin-top:20px;">Buy Controls</h4>
        <div id="buy-controls">
            <div class="control-box"><span>Niva Buying</span><button id="ctrl-Niva" class="switch-btn" onclick="toggleBuy('Niva')">Loading...</button></div>
            <div class="control-box"><span>NS Buying</span><button id="ctrl-NS" class="switch-btn" onclick="toggleBuy('NS')">Loading...</button></div>
            <div class="control-box"><span>Riva Buying</span><button id="ctrl-Riva" class="switch-btn" onclick="toggleBuy('Riva')">Loading...</button></div>
        </div>

        <h4 style="margin-top: 20px;">Orders</h4>
        <div id="admin-list"></div>
    </div>

    <div id="sell-page" class="page">
        <button onclick="showPage('home-page')" style="margin-bottom: 15px; border: none; background: #ddd; padding: 8px 15px; border-radius: 10px;">‚Üê Back</button>
        <div style="background: white; padding: 20px; border-radius: 20px;">
            <h3 id="form-title">Sell Coin</h3>
            
            <label>Admin Username (Send Coins Here)</label>
            <input type="text" id="admin-user-display" readonly style="background: #f0f0f0; color: #d35400; font-weight: bold;">

            <label>Amount (Coins)</label>
            <input type="number" id="inp-amount" placeholder="Ex: 1000">
            <label>Payment Method</label>
            <select id="inp-method"><option>Bkash</option><option>Nagad</option><option>Rocket</option></select>
            <label>Your Number</label>
            <input type="text" id="inp-number" placeholder="01XXXXXXXXX">
            <label>Your Wallet Username</label>
            <input type="text" id="inp-wallet" placeholder="@username">
            <button class="sell-btn" onclick="submitOrder()" style="background: #27ae60;">Submit Order</button>
        </div>
    </div>

    <div id="history-page" class="page">
        <button onclick="showPage('home-page')" style="margin-bottom: 15px; border: none; background: #ddd; padding: 8px 15px; border-radius: 10px;">‚Üê Back</button>
        <h3>üìú My Orders</h3>
        <div id="history-list"></div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const DB_URL = "https://coin-market-e4c85-default-rtdb.firebaseio.com";
        const ADMIN_ID = 6822761216; // üëà ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶∏‡¶æ‡¶®

        const user = tg.initDataUnsafe.user || {id: 123, first_name: "TestUser"};
        let coinStatus = { Niva: true, NS: true, Riva: true };
        
        document.getElementById('user-display-name').innerText = user.first_name;
        document.getElementById('user-display-id').innerText = "ID: " + user.id;
        document.getElementById('user-pic').src = user.photo_url || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";

        if(user.id == ADMIN_ID) document.getElementById('admin-panel-btn').style.display = 'block';

        // Fetch Initial Status
        async function fetchStatus() {
            try {
                let res = await fetch(`${DB_URL}/status.json`);
                let data = await res.json();
                if(data) {
                    coinStatus = data;
                    updateMarketUI();
                }
            } catch(e) {}
        }
        fetchStatus();

        function updateMarketUI() {
            ['Niva', 'NS', 'Riva'].forEach(c => {
                const btn = document.getElementById(`btn-${c}`);
                const tag = document.getElementById(`tag-${c}`);
                const ctrl = document.getElementById(`ctrl-${c}`);
                
                if(coinStatus[c]) {
                    btn.disabled = false;
                    btn.innerText = `Sell ${c}`;
                    tag.innerText = "ONLINE";
                    tag.style.background = "#27ae60";
                    if(ctrl) { ctrl.innerText = "STOP"; ctrl.style.background = "#e74c3c"; ctrl.style.color = "white"; }
                } else {
                    btn.disabled = true;
                    btn.innerText = "BUYING STOP";
                    tag.innerText = "OFFLINE";
                    tag.style.background = "#777";
                    if(ctrl) { ctrl.innerText = "START"; ctrl.style.background = "#27ae60"; ctrl.style.color = "white"; }
                }
            });
        }

        async function toggleBuy(coin) {
            coinStatus[coin] = !coinStatus[coin];
            await fetch(`${DB_URL}/status.json`, { method: 'PUT', body: JSON.stringify(coinStatus) });
            updateMarketUI();
        }

        function showPage(id) {
            document.querySelectorAll('.page, #home-page').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'admin-page') fetchAdminData();
            if(id === 'history-page') fetchHistory();
        }

        let selCoin, selRate;
        function openForm(c, r, adminUser) { 
            if(!coinStatus[c]) return alert("Buying is currently stopped for this coin.");
            selCoin = c; 
            selRate = r; 
            document.getElementById('form-title').innerText = "Sell " + c; 
            document.getElementById('admin-user-display').value = adminUser;
            showPage('sell-page'); 
        }

        async function submitOrder() {
            let amt = document.getElementById('inp-amount').value;
            if(!amt) return alert("Enter Amount!");
            let order = {
                uid: user.id, uName: user.first_name, coin: selCoin,
                amt: amt, method: document.getElementById('inp-method').value,
                num: document.getElementById('inp-number').value,
                wallet: document.getElementById('inp-wallet').value,
                payout: (amt / 1000 * selRate).toFixed(2),
                status: "Pending", time: new Date().toLocaleString()
            };
            await fetch(`${DB_URL}/orders.json`, { method: 'POST', body: JSON.stringify(order) });
            alert("Order Submitted!"); showPage('history-page');
        }

        async function fetchAdminData() {
            let res = await fetch(`${DB_URL}/orders.json`);
            let data = await res.json();
            let list = document.getElementById('admin-list');
            list.innerHTML = "";
            let p = 0, d = 0, r = 0;

            for(let key in data) {
                let o = data[key];
                if(o.status === "Pending") {
                    p++;
                    list.innerHTML += `
                        <div class="order-item">
                            <b style="color:#2481cc;">${o.coin} Order</b><br>
                            User: ${o.uName} (${o.uid})<br>
                            Amount: ${o.amt} | <b>Pay: ${o.payout}‡ß≥</b><br>
                            ${o.method}: ${o.num} | Wallet: ${o.wallet}<br>
                            <div class="admin-btn-group">
                                <button class="btn-accept" onclick="updateStatus('${key}', 'Paid')">Accept</button>
                                <button class="btn-reject" onclick="updateStatus('${key}', 'Rejected')">Reject</button>
                            </div>
                        </div>`;
                } else if(o.status === "Paid") d++; else r++;
            }
            document.getElementById('count-pending').innerText = p;
            document.getElementById('count-paid').innerText = d;
            document.getElementById('count-rej').innerText = r;
            updateMarketUI();
        }

        async function fetchHistory() {
            let res = await fetch(`${DB_URL}/orders.json`);
            let data = await res.json();
            let list = document.getElementById('history-list');
            list.innerHTML = "";
            if(!data) return;
            for(let key in data) {
                let o = data[key];
                if(o.uid == user.id) {
                    let color = o.status === 'Paid' ? 'green' : (o.status === 'Pending' ? 'orange' : 'red');
                    list.innerHTML += `<div class="order-item" style="border-left-color:${color}">
                        <b>${o.coin} - ${o.amt}</b><br>Payout: ${o.payout}‡ß≥ | Status: <span style="color:${color}">${o.status}</span></div>`;
                }
            }
        }

        async function updateStatus(key, s) {
            await fetch(`${DB_URL}/orders/${key}.json`, { method: 'PATCH', body: JSON.stringify({status: s}) });
            fetchAdminData();
        }
    </script>
</body>
</html>
