<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Niva Buyer Zone</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p-blue: #2481cc; --bg: #f0f7ff; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 80px; color: #333; }
        
        .admin-header { background: linear-gradient(90deg, #1d71b8, #4a90e2); border-radius: 20px; padding: 15px; display: flex; justify-content: space-between; align-items: center; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .p-info { display: flex; align-items: center; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff; margin-right: 12px; object-fit: cover; background: #eee; }

        .coin-card { background: white; border-radius: 25px; padding: 20px; margin-top: 20px; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .offline-tag { position: absolute; top: 0; right: 0; background: #27ae60; color: white; padding: 5px 15px; font-size: 10px; border-bottom-left-radius: 15px; font-weight: bold; }
        .rate-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .rate-box { background: #f8fbff; padding: 12px; border-radius: 12px; text-align: center; }
        .sell-btn { background: var(--p-blue); color: white; width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: bold; margin-top: 15px; cursor: pointer; display: block; }

        .page { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .active { display: block !important; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        .order-item { background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid orange; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        #admin-panel-btn { display: none; background: #333; color: white; margin-top: 15px; }
    </style>
</head>
<body>

    <div id="home-page">
        <div class="admin-header">
            <div class="p-info">
                <img id="user-pic" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="avatar">
                <div>
                    <b id="user-display-name">Loading...</b><br>
                    <small id="user-display-id">ID: 000000</small>
                </div>
            </div>
            <div style="text-align:right"><small>Status</small><br><b>üü¢ Online</b></div>
        </div>

        <button id="admin-panel-btn" class="sell-btn" onclick="showPage('admin-page')">üëë Admin Dashboard</button>

        <div id="coin-market">
            <div class="coin-card">
                <div class="offline-tag">ONLINE</div>
                <b>üü¢ Niva Coin</b>
                <div class="rate-grid">
                    <div class="rate-box"><small>RATE</small><br><b>3.8‡ß≥</b></div>
                    <div class="rate-box"><small>ADMIN</small><br><b>3.8‡ß≥</b></div>
                </div>
                <button class="sell-btn" onclick="openForm('Niva', 3.8)">Sell Niva</button>
            </div>
            <div class="coin-card">
                <div class="offline-tag" style="background: #2481cc;">ONLINE</div>
                <b>üîµ NS Coin</b>
                <div class="rate-grid"><div class="rate-box"><b>5.0‡ß≥</b></div><div class="rate-box"><b>5.0‡ß≥</b></div></div>
                <button class="sell-btn" onclick="openForm('NS', 5.0)">Sell NS</button>
            </div>
            <div class="coin-card">
                <div class="offline-tag" style="background: #8e44ad;">ONLINE</div>
                <b>üü£ Riva Coin</b>
                <div class="rate-grid"><div class="rate-box"><b>8.2‡ß≥</b></div><div class="rate-box"><b>8.2‡ß≥</b></div></div>
                <button class="sell-btn" onclick="openForm('Riva', 8.2)">Sell Riva</button>
            </div>
        </div>
        <button class="sell-btn" style="background:#8e44ad" onclick="showPage('history-page')">üìú My History</button>
    </div>

    <div id="sell-page" class="page">
        <button onclick="showPage('home-page')">‚Üê Back</button>
        <div class="order-item" style="margin-top:20px">
            <h3 id="form-title">Sell Coin</h3>
            <input type="number" id="inp-amount" placeholder="Coin Amount">
            <select id="inp-method"><option>Bkash</option><option>Nagad</option><option>Rocket</option></select>
            <input type="text" id="inp-number" placeholder="Payment Number">
            <input type="text" id="inp-wallet" placeholder="Wallet Username">
            <button class="sell-btn" id="sub-btn" onclick="submitOrder()" style="background:#27ae60">Submit to Admin</button>
        </div>
    </div>

    <div id="history-page" class="page">
        <button onclick="showPage('home-page')">‚Üê Back</button>
        <h3>üìú My History</h3>
        <div id="history-list"></div>
    </div>

    <div id="admin-page" class="page">
        <button onclick="showPage('home-page')">‚Üê Back</button>
        <h3>üëë Admin Dashboard</h3>
        <div id="admin-list"></div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // üü¢ Firebase & Admin Setup
        const DB_URL = "https://coin-market-e4c85-default-rtdb.firebaseio.com";
        const MY_ADMIN_ID = 123456789; // üëà Ekhane apnar ID boshan

        const user = tg.initDataUnsafe.user || { id: 123, first_name: "Test User" };

        // User Info UI Update
        document.getElementById('user-display-name').innerText = user.first_name;
        document.getElementById('user-display-id').innerText = "ID: " + user.id;
        if(user.photo_url) document.getElementById('user-pic').src = user.photo_url;
        
        if(user.id == MY_ADMIN_ID) {
            document.getElementById('admin-panel-btn').style.display = 'block';
        }

        function showPage(id) {
            document.querySelectorAll('.page, #home-page').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'history-page') fetchHistory();
            if(id === 'admin-page') fetchAdmin();
        }

        let selCoin, selRate;
        function openForm(c, r) {
            selCoin = c; selRate = r;
            document.getElementById('form-title').innerText = "Sell " + c;
            showPage('sell-page');
        }

        async function submitOrder() {
            let amt = document.getElementById('inp-amount').value;
            let num = document.getElementById('inp-number').value;
            if(!amt || !num) return alert("Please fill all fields!");

            let order = {
                uid: user.id,
                uName: user.first_name,
                coin: selCoin,
                amt: amt,
                num: num,
                method: document.getElementById('inp-method').value,
                wallet: document.getElementById('inp-wallet').value,
                payout: (amt/1000 * selRate).toFixed(2),
                status: "Pending",
                time: new Date().toLocaleString()
            };

            try {
                await fetch(`${DB_URL}/orders.json`, { method: 'POST', body: JSON.stringify(order) });
                alert("Order submitted!");
                showPage('history-page');
            } catch(e) { alert("Error connecting to database!"); }
        }

        async function fetchHistory() {
            let list = document.getElementById('history-list');
            list.innerHTML = "Loading...";
            try {
                let res = await fetch(`${DB_URL}/orders.json`);
                let data = await res.json();
                list.innerHTML = "";
                if(!data) { list.innerHTML = "No history found."; return; }
                Object.values(data).reverse().forEach(o => {
                    if(o.uid == user.id) {
                        list.innerHTML += `<div class="order-item"><b>${o.coin} - ${o.amt}</b><br>Pay: ${o.payout}‡ß≥<br>Status: ${o.status}</div>`;
                    }
                });
            } catch(e) { list.innerHTML = "Error!"; }
        }

        async function fetchAdmin() {
            let list = document.getElementById('admin-list');
            list.innerHTML = "Loading...";
            try {
                let res = await fetch(`${DB_URL}/orders.json`);
                let data = await res.json();
                list.innerHTML = "";
                for(let key in data) {
                    let o = data[key];
                    if(o.status === "Pending") {
                        list.innerHTML += `<div class="order-item">${o.uName} (@${o.wallet})<br>${o.coin}: ${o.amt}<br>${o.method}: ${o.num}<br>
                        <button onclick="updateStatus('${key}', 'Received')" style="background:green;color:white;border:none;padding:5px;border-radius:5px">Accept</button>
                        <button onclick="updateStatus('${key}', 'Rejected')" style="background:red;color:white;border:none;padding:5px;border-radius:5px">Reject</button></div>`;
                    }
                }
            } catch(e) { list.innerHTML = "Error!"; }
        }

        async function updateStatus(key, s) {
            await fetch(`${DB_URL}/orders/${key}.json`, { method: 'PATCH', body: JSON.stringify({status: s}) });
            alert("Updated!");
            fetchAdmin();
        }
    </script>
</body>
</html>
