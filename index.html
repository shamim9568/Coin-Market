<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p-blue: #2481cc; --bg: #f0f7ff; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 80px; color: #333; }
        
        /* User Profile Header */
        .admin-header { background: linear-gradient(90deg, #1d71b8, #4a90e2); border-radius: 20px; padding: 15px; display: flex; justify-content: space-between; align-items: center; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .p-info { display: flex; align-items: center; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff; margin-right: 12px; object-fit: cover; }

        /* Coin Cards */
        .coin-card { background: white; border-radius: 25px; padding: 20px; margin-top: 20px; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .offline-tag { position: absolute; top: 0; right: 0; background: #27ae60; color: white; padding: 5px 15px; font-size: 10px; border-bottom-left-radius: 15px; font-weight: bold; }
        .rate-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .rate-box { background: #f8fbff; padding: 12px; border-radius: 12px; text-align: center; }
        .sell-btn { background: var(--p-blue); color: white; width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: bold; margin-top: 15px; cursor: pointer; }

        /* Page Management */
        .page { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .active { display: block !important; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; }
        .form-card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .back-btn { background: #555; color: #fff; padding: 8px 15px; border-radius: 10px; border: none; margin-bottom: 15px; }

        .order-item { background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid orange; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        #admin-panel-btn { display: none; background: #333; color: white; margin-top: 15px; }
    </style>
</head>
<body>

    <div id="home-page">
        <div class="admin-header">
            <div class="p-info">
                <img id="user-pic" src="https://via.placeholder.com/50" class="avatar">
                <div>
                    <b id="user-display-name">Loading...</b><br>
                    <small id="user-display-id">ID: 000000</small>
                </div>
            </div>
            <div style="text-align:right"><small>Status</small><br><b>üü¢ Online</b></div>
        </div>

        <button id="admin-panel-btn" class="sell-btn" onclick="showPage('admin-page')">üëë Admin Dashboard</button>

        <div id="coin-market">
            <div class="coin-card">
                <div class="offline-tag">ONLINE</div>
                <b>üü¢ Niva Coin</b>
                <div class="rate-grid">
                    <div class="rate-box"><small>RATE</small><br><b>3.8‡ß≥</b></div>
                    <div class="rate-box"><small>ADMIN</small><br><b>3.8‡ß≥</b></div>
                </div>
                <button class="sell-btn" onclick="openForm('Niva', 3.8)">Sell Niva</button>
            </div>

            <div class="coin-card">
                <div class="offline-tag" style="background: #2481cc;">ONLINE</div>
                <b>üîµ NS Coin</b>
                <div class="rate-grid">
                    <div class="rate-box"><small>RATE</small><br><b>18‡ß≥</b></div>
                    <div class="rate-box"><small>ADMIN</small><br><b>18.5‡ß≥</b></div>
                </div>
                <button class="sell-btn" onclick="openForm('NS', 18)">Sell NS</button>
            </div>

            <div class="coin-card">
                <div class="offline-tag" style="background: #8e44ad;">offline</div>
                <b>üü£ Riva Coin</b>
                <div class="rate-grid">
                    <div class="rate-box"><small>RATE</small><br><b>5.5‡ß≥</b></div>
                    <div class="rate-box"><small>ADMIN</small><br><b>5.5‡ß≥</b></div>
                </div>
                <button class="sell-btn" onclick="openForm('Riva', 5.5)">Sell Riva</button>
            </div>
        </div>
        
        <button class="sell-btn" style="background:#8e44ad" onclick="showPage('history-page')">üìú My History</button>
    </div>

    <div id="sell-page" class="page">
        <button class="back-btn" onclick="showPage('home-page')">‚Üê Back</button>
        <div class="form-card">
            <h3 id="form-title">Sell Coin</h3>
            <label>Admin Wallet Username</label>
            <input type="text" value="shamim44035" readonly style="background:#f1f1f1">
            <label>Coin Amount</label>
            <input type="number" id="inp-amount" placeholder="Ex: 1000">
            <label>Payment Method</label>
            <select id="inp-method">
                <option value="Bkash">Bkash</option>
                <option value="Nagad">Nagad</option>
                <option value="Rocket">Rocket</option>
            </select>
            <label>Your Payment Number</label>
            <input type="text" id="inp-number" placeholder="01XXXXXXXXX">
            <label>Your Username (Sender)</label>
            <input type="text" id="inp-wallet" placeholder="Username">
            <button class="sell-btn" id="submit-order-btn" onclick="submitOrder()" style="background:#27ae60">Submit to Admin</button>
        </div>
    </div>

    <div id="history-page" class="page">
        <button class="back-btn" onclick="showPage('home-page')">‚Üê Back</button>
        <h3>üìú Transaction History</h3>
        <div id="history-list"></div>
    </div>

    <div id="admin-page" class="page">
        <button class="back-btn" onclick="showPage('home-page')">‚Üê Logout Admin</button>
        <h3>üëë Admin Panel (Pending)</h3>
        <div id="admin-list"></div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // üü¢ CONFIGURATION (Firebase)
        const DB_URL = https://coin-market-e4c85-default-rtdb.firebaseio.com// üëà ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Firebase Database ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡¶ø‡¶®
        const MY_ADMIN_ID = 6822761216; // üëà ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡¶ø‡¶®

        const user = tg.initDataUnsafe.user;
        if (user) {
            document.getElementById('user-display-name').innerText = user.first_name + (user.last_name ? " " + user.last_name : "");
            document.getElementById('user-display-id').innerText = "ID: " + user.id;
            if (user.photo_url) document.getElementById('user-pic').src = user.photo_url;
            
            if (user.id === MY_ADMIN_ID) {
                document.getElementById('admin-panel-btn').style.display = 'block';
            }
        }

        let current_coin = "";
        let current_rate = 0;

        function showPage(id) {
            document.querySelectorAll('.page, #home-page').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'history-page') fetchHistory();
            if(id === 'admin-page') fetchAdminOrders();
        }

        function openForm(coin, rate) {
            current_coin = coin;
            current_rate = rate;
            document.getElementById('form-title').innerText = "Sell " + coin;
            showPage('sell-page');
        }

        // üì§ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
        async function submitOrder() {
            let amount = document.getElementById('inp-amount').value;
            let method = document.getElementById('inp-method').value;
            let number = document.getElementById('inp-number').value;
            let wallet = document.getElementById('inp-wallet').value;

            if(!amount || !number || !wallet) return alert("Fill all boxes!");

            const btn = document.getElementById('submit-order-btn');
            btn.disabled = true; btn.innerText = "Submitting...";

            let orderData = {
                userId: user.id,
                userName: user.first_name,
                coin: current_coin,
                amount: amount,
                method: method,
                number: number,
                wallet: wallet,
                total: ((amount/1000) * current_rate).toFixed(2),
                status: "Pending",
                timestamp: Date.now()
            };

            try {
                await fetch(`${DB_URL}/orders.json`, {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });
                alert("Submitted Successfully!");
                document.getElementById('inp-amount').value = "";
                document.getElementById('inp-number').value = "";
                document.getElementById('inp-wallet').value = "";
                showPage('history-page');
            } catch (e) {
                alert("Error submitting order!");
            } finally {
                btn.disabled = false; btn.innerText = "Submit to Admin";
            }
        }

        // üì• ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶®‡¶ø‡ßü‡ßá ‡¶Ü‡¶∏‡¶æ
        async function fetchHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = "Loading...";
            try {
                let res = await fetch(`${DB_URL}/orders.json`);
                let data = await res.json();
                list.innerHTML = "";
                if(!data) { list.innerHTML = "No history found."; return; }

                Object.keys(data).reverse().forEach(key => {
                    let o = data[key];
                    if(o.userId === user.id) {

                        let statusColor = o.status === "Received" ? "green" : (o.status === "Rejected" ? "red" : "orange");
